<<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lợi Lê CONVERTER (Phong cách Nhật - Tech)</title>
    <!-- Tải Tailwind CSS để sử dụng các class utility -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Tải Font Inter và các icon Font Awesome -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <style>
        /* Thiết lập biến CSS cho Theme */
        :root {
            /* Light Theme */
            --bg-body: #f7f7f7;
            --bg-container: rgba(255, 255, 255, 0.95);
            --bg-option: #F9FAFB;
            --text-primary: #1F2937;
            --text-secondary: #4B5563;
            --border-color: #D1D5DB;
            --result-bg: linear-gradient(135deg, #FFEEEE 0%, #FFFFFF 100%);
            --result-border: #FCA5A5;
            --romaji-color: #BC002D;
            --hiragana-color: #1F2937;
            --title-color-light: #BC002D; /* Màu Đỏ HUST/Nhật */
        }

        /* Dark Theme */
        .dark {
            --bg-body: #111827; /* Dark Slate */
            --bg-container: rgba(31, 41, 55, 0.98); /* Darker Slate */
            --bg-option: #1F2937; /* Even Darker */
            --text-primary: #F3F4F6; /* Light Text */
            --text-secondary: #9CA3AF; /* Gray Text */
            --border-color: #374151; /* Dark Border */
            --result-bg: linear-gradient(135deg, #37000B 0%, #1F2937 100%); /* Dark Red Gradient */
            --result-border: #991B1B; /* Dark Red Border */
            --romaji-color: #FCA5A5; /* Light Red */
            --hiragana-color: #D1D5DB; /* Light Gray */
            --title-color-dark: #FFD700; /* Màu Vàng Kim */
        }

        /* Cài đặt chung */
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            min-height: 100vh;
            background-color: var(--bg-body); 
            color: var(--text-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow-x: hidden;
            position: relative;
            transition: background-color 0.5s, color 0.5s;
        }

        /* ------------------------------------- */
        /* HIỆU ỨNG NỀN MATRIX */
        /* ------------------------------------- */
        #matrix-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1; 
            opacity: 0.35; 
            filter: grayscale(0%) brightness(1.2) contrast(1.5); 
            transition: opacity 0.5s, filter 0.5s;
        }
        .dark #matrix-background {
            opacity: 0.5; /* Đậm hơn trong Dark mode */
            filter: grayscale(0%) brightness(1.5) contrast(1.5);
        }

        /* Container ứng dụng */
        .app-container {
            position: relative;
            z-index: 5;
            max-width: 480px;
            width: 95%;
            padding: 30px;
            background-color: var(--bg-container); 
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1), 0 5px 15px rgba(0, 0, 0, 0.05);
            backdrop-filter: blur(5px); 
            border: 2px solid var(--border-color); 
            transition: background-color 0.5s, border-color 0.5s, box-shadow 0.5s;
        }
        .dark .app-container {
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.4), 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        /* ------------------------------------- */
        /* STYLE CHO TIÊU ĐỀ MỚI: LỢI LÊ CONVERTER */
        /* ------------------------------------- */
        .app-title {
            font-size: 2.25rem; /* text-4xl */
            font-weight: 900; /* font-extrabold */
            text-transform: uppercase;
            letter-spacing: 2px;
            
            /* Light Theme: Màu Đỏ HUST/Nhật */
            color: var(--title-color-light); 
            text-shadow: 
                0 0 5px rgba(188, 0, 45, 0.4), 
                0 0 10px rgba(188, 0, 45, 0.2); 
            
            transition: all 0.5s;
        }

        .dark .app-title {
            /* Dark Theme: Màu Vàng Kim */
            color: var(--title-color-dark);
            background-image: linear-gradient(45deg, #FFD700, #FFA500); /* Gradient vàng cam */
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 
                0 0 10px rgba(255, 215, 0, 0.7), 
                0 0 20px rgba(255, 165, 0, 0.5); /* Hiệu ứng Glowing */
            animation: pulse-shadow 3s infinite alternate;
        }

        @keyframes pulse-shadow {
            0% {
                text-shadow: 0 0 8px rgba(255, 215, 0, 0.8), 0 0 12px rgba(255, 165, 0, 0.6);
            }
            100% {
                text-shadow: 0 0 12px rgba(255, 215, 0, 1), 0 0 25px rgba(255, 165, 0, 0.8);
            }
        }

        .subtitle {
            color: var(--text-secondary);
            transition: color 0.5s;
        }

        /* ------------------------------------- */
        /* STYLE CHO INPUT VÀ BUTTON */
        /* ------------------------------------- */
        .input-field {
            border: 1px solid var(--border-color);
            background-color: var(--bg-body);
            color: var(--text-primary);
            border-radius: 10px;
            padding: 12px;
            transition: border-color 0.3s, box-shadow 0.3s, background-color 0.5s, color 0.5s;
        }
        .input-field:focus {
            border-color: #F87171; 
            box-shadow: 0 0 0 3px rgba(248, 113, 113, 0.4);
        }
        .dark .input-field {
            background-color: #1F2937;
            border-color: #4B5563;
        }

        .btn-primary {
            background-color: #BC002D; 
            color: white;
            padding: 12px 20px;
            border-radius: 10px;
            font-weight: 600;
            transition: background-color 0.2s, transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px #990022; 
        }
        .btn-primary:hover {
            background-color: #A30027;
            transform: translateY(-1px);
            box-shadow: 0 5px #990022;
        }
        .btn-primary:active {
            transform: translateY(3px);
            box-shadow: 0 1px #990022;
        }

        .btn-secondary {
            background-color: var(--bg-body);
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
            padding: 8px 12px;
            border-radius: 8px;
            transition: background-color 0.3s, color 0.3s, transform 0.2s;
        }
        .btn-secondary:hover {
            background-color: #E5E7EB;
            color: #1F2937;
        }
        .dark .btn-secondary {
            background-color: #374151;
            color: #D1D5DB;
            border-color: #4B5563;
        }
        .dark .btn-secondary:hover {
            background-color: #4B5563;
            color: white;
        }
        
        /* ------------------------------------- */
        /* STYLE CHO HỘP KẾT QUẢ VÀ HIỆU ỨNG GLOWING */
        /* ------------------------------------- */
        .result-group {
            background: var(--result-bg); 
            border: 2px solid var(--result-border); 
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1), 0 0 15px rgba(252, 165, 165, 0.5); 
            transition: all 0.5s ease-in-out;
            margin-top: 20px;
            padding: 20px;
            opacity: 0; /* Khởi tạo ẩn */
            transform: scale(0.95) translateY(10px);
            animation: fadeIn 0.5s forwards;
        }

        .dark .result-group {
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3), 0 0 15px rgba(153, 27, 27, 0.7);
        }
        
        @keyframes fadeIn {
            to { 
                opacity: 1; 
                transform: scale(1) translateY(0);
            }
        }
        
        @keyframes glowing-effect {
            0% { box-shadow: 0 0 5px var(--result-border), 0 0 10px var(--result-border); }
            50% { box-shadow: 0 0 15px var(--result-border), 0 0 20px var(--result-border); }
            100% { box-shadow: 0 0 5px var(--result-border), 0 0 10px var(--result-border); }
        }

        .glowing {
            animation: glowing-effect 1.5s infinite alternate;
        }

        #romajiOutput {
            font-family: monospace; 
            font-size: 30px; 
            font-weight: 700; 
            color: var(--romaji-color); 
            text-align: center;
            text-shadow: 
                0 0 5px rgba(188, 0, 45, 0.3), 
                0 0 1px rgba(188, 0, 45, 0.8); 
            line-height: 1.2;
            word-break: break-word; 
            transition: color 0.5s;
        }
        .dark #romajiOutput {
             text-shadow: 
                0 0 5px rgba(252, 165, 165, 0.5), 
                0 0 1px rgba(252, 165, 165, 1);
        }

        #hiraganaOutput {
            font-size: 32px; 
            font-weight: 600; 
            color: var(--hiragana-color); 
            text-align: center;
            padding-top: 10px;
            word-break: break-word; 
            transition: color 0.5s;
        }

        .control-button {
            background-color: #FEE2E2;
            color: #BC002D;
            transition: background-color 0.2s, transform 0.2s, color 0.2s;
        }
        .control-button:hover {
            background-color: #FCA5A5;
            color: white;
            transform: scale(1.05);
        }
        .dark .control-button {
            background-color: #374151;
            color: #FCA5A5;
        }
        .dark .control-button:hover {
            background-color: #991B1B;
            color: white;
        }

        /* Style cho khối tùy chọn (IT hiện đại) */
        .option-group {
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 15px;
            background-color: var(--bg-option);
            transition: background-color 0.5s, border-color 0.5s;
        }

        /* Style cho History */
        #historyContainer {
            margin-top: 25px;
        }
        .history-item {
            cursor: pointer;
            padding: 8px 12px;
            margin-bottom: 5px;
            background-color: var(--bg-option);
            border-radius: 8px;
            border-left: 5px solid #BC002D;
            transition: background-color 0.3s, transform 0.1s;
        }
        .history-item:hover {
            background-color: #FEE2E2;
            transform: translateY(-1px);
        }
        .dark .history-item {
            border-left: 5px solid #FCA5A5;
            background-color: #1F2937;
        }
        .dark .history-item:hover {
            background-color: #374151;
        }

        /* Style cho Footer */
        .app-footer {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
        }
        .hust-logo {
            width: 45px;
            height: 45px;
            margin-bottom: 8px;
            border-radius: 50%;
            border: 2px solid #BC002D;
            background-color: #FFFFFF;
            object-fit: contain;
        }
        .dark .hust-logo {
             border-color: #FCA5A5;
             background-color: #1F2937;
        }
        .fb-link {
            color: #3B82F6;
            text-decoration: none;
            transition: color 0.2s;
        }
        .fb-link:hover {
            text-decoration: underline;
        }
        
    </style>
</head>
<body class="light">

    <!-- Canvas cho hiệu ứng nền Matrix -->
    <canvas id="matrix-background"></canvas>

    <!-- Nội dung chính của ứng dụng -->
    <div class="app-container">
        
        <!-- HEADER (Japan Tech Style) -->
        <div class="header-content text-center mb-6">
            <div class="flex justify-end mb-2">
                 <!-- Nút Chuyển Theme -->
                <button id="themeToggle" class="btn-secondary flex items-center gap-1 text-xs">
                    <i class="fas fa-moon" id="themeIcon"></i>
                    <span id="themeText">Chủ đề Tối</span>
                </button>
            </div>
            
            <!-- TIÊU ĐỀ ĐÃ ĐƯỢC CHỈNH SỬA -->
            <div class="app-title">
                LỢI LÊ CONVERTER
            </div>
            <!-- PHỤ ĐỀ ĐÃ ĐƯỢC CHỈNH SỬA -->
            <p class="subtitle">Công cụ cá nhân: Chuyển đổi số đếm tiếng Nhật (0 - 9,999,999)</p>
            <div class="text-xs text-gray-500 mt-2 p-1 bg-gray-100 rounded-full inline-block px-3 dark:bg-gray-800 dark:text-gray-400 transition-colors">
                <i class="fas fa-microchip mr-1"></i> Hệ thống IT - Nhật Bản
            </div>
        </div>

        <!-- KHỐI TÙY CHỌN GIỌNG ĐỌC -->
        <div class="option-group mb-6">
            <h3 class="text-lg font-bold text-gray-700 mb-4 flex items-center dark:text-gray-300">
                <i class="fas fa-sliders-h text-red-500 mr-2"></i> Tùy Chỉnh Giọng Đọc
            </h3>
            
            <div class="space-y-4 text-sm">
                <!-- Giọng Đọc -->
                <div class="flex flex-col">
                    <label for="voiceSelect" class="font-medium text-gray-600 mb-1 dark:text-gray-400">
                        <i class="fas fa-microphone text-blue-500 mr-1"></i> Giọng Đọc (Chỉ hiển thị giọng Nhật):
                    </label>
                    <select id="voiceSelect" class="input-field w-full">
                        <!-- Options will be populated by JavaScript -->
                    </select>
                </div>
                
                <!-- Tốc Độ & Cao Độ -->
                <div class="grid grid-cols-2 gap-4">
                    <div class="flex flex-col">
                        <label for="rateRange" class="font-medium text-gray-600 mb-1 flex justify-between items-center dark:text-gray-400">
                            <i class="fas fa-tachometer-alt text-gray-500 mr-1"></i> Tốc Độ:
                            <span id="rateValue" class="font-mono text-xs text-gray-600 dark:text-gray-400">1.0</span>
                        </label>
                        <input type="range" id="rateRange" min="0.5" max="2" value="1.0" step="0.1" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer dark:bg-gray-600">
                    </div>
                    
                    <div class="flex flex-col">
                        <label for="pitchRange" class="font-medium text-gray-600 mb-1 flex justify-between items-center dark:text-gray-400">
                            <i class="fas fa-wave-square text-gray-500 mr-1"></i> Cao Độ (Pitch):
                            <span id="pitchValue" class="font-mono text-xs text-gray-600 dark:text-gray-400">1.0</span>
                        </label>
                        <input type="range" id="pitchRange" min="0" max="2" value="1.0" step="0.1" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer dark:bg-gray-600">
                    </div>
                </div>
                
                <!-- Tự động đọc sau chuyển đổi -->
                <div class="flex items-center pt-2">
                    <input type="checkbox" id="autoSpeakCheckbox" checked class="h-4 w-4 text-red-600 border-gray-300 rounded focus:ring-red-500 mr-2 dark:bg-gray-700 dark:border-gray-600">
                    <label for="autoSpeakCheckbox" class="font-medium text-gray-600 dark:text-gray-400">
                        <i class="fas fa-magic mr-1"></i> Tự động đọc sau khi chuyển đổi
                    </label>
                </div>
            </div>
        </div>

        <!-- KHỐI NHẬP SỐ VÀ CHUYỂN ĐỔI -->
        <div class="mb-4">
            <h3 class="text-lg font-bold text-gray-700 mb-4 flex items-center dark:text-gray-300">
                <i class="fas fa-hashtag text-red-500 mr-2"></i> Nhập Số Cần Chuyển Đổi:
            </h3>
            
            <input type="number" id="inputNumber" placeholder="Ví dụ: 10000, 350000, 9999999" 
                   class="input-field w-full text-xl text-center tracking-wide" 
                   min="0" max="9999999">
        </div>

        <!-- NÚT CHUYỂN ĐỔI & CONTROL -->
        <div class="grid grid-cols-3 gap-3 mb-6">
            <button id="refreshButton" class="btn-secondary flex items-center justify-center text-sm">
                <i class="fas fa-sync-alt mr-1"></i> Làm mới
            </button>
            <button id="clearButton" class="btn-secondary flex items-center justify-center text-sm">
                <i class="fas fa-times mr-1"></i> Xóa nhanh
            </button>
            <button id="convertButton" class="btn-primary col-span-1 flex items-center justify-center gap-2">
                <i class="fas fa-exchange-alt"></i> Chuyển Đổi
            </button>
        </div>


        <!-- KHỐI KẾT QUẢ -->
        <div id="resultBox" class="result-group hidden">
            
            <!-- Romaji Result -->
            <div class="mb-3">
                <div class="flex justify-between items-center mb-1">
                    <span class="text-sm font-semibold text-gray-700 flex items-center dark:text-gray-400">
                        <i class="fas fa-check-circle text-green-500 mr-2"></i> Kết Quả Romaji:
                    </span>
                    <div class="space-x-2">
                        <button id="speakerButton" class="control-button px-3 py-1 rounded-full text-xs font-semibold">
                            <i class="fas fa-volume-up mr-1"></i> Đọc
                        </button>
                        <button id="copyRomajiButton" class="control-button px-3 py-1 rounded-full text-xs font-semibold">
                            <i class="fas fa-copy mr-1"></i> Copy R.
                        </button>
                    </div>
                </div>
                <div id="romajiOutput" class="text-2xl font-mono"></div>
            </div>

            <div class="border-t border-red-200 my-3 dark:border-red-800"></div> <!-- Đường phân cách -->

            <!-- Hiragana Result -->
            <div>
                <div class="flex justify-between items-center mb-1">
                    <span class="text-sm font-semibold text-gray-700 flex items-center dark:text-gray-400">
                        <i class="fas fa-book-open text-blue-500 mr-2"></i> Kết Quả Hiragana:
                    </span>
                    <button id="copyHiraganaButton" class="control-button px-3 py-1 rounded-full text-xs font-semibold">
                        <i class="fas fa-copy mr-1"></i> Copy H.
                    </button>
                </div>
                <div id="hiraganaOutput" class="text-2xl"></div>
            </div>
            
        </div>

        <!-- Hộp lỗi (Đỏ và Cảnh báo) -->
        <div id="errorMessage" class="hidden mt-4 p-4 text-sm text-red-700 bg-red-100 rounded-lg border border-red-300 dark:bg-red-900 dark:text-red-300 dark:border-red-700" role="alert">
            <i class="fas fa-exclamation-triangle mr-2"></i>
            <span id="errorText"></span>
        </div>
        
        <!-- KHỐI LỊCH SỬ CHUYỂN ĐỔI -->
        <div id="historyContainer" class="mt-8">
            <h3 class="text-lg font-bold text-gray-700 mb-3 flex items-center dark:text-gray-300">
                <i class="fas fa-history text-red-500 mr-2"></i> Lịch Sử 5 Lần Gần Nhất
            </h3>
            <div id="historyList" class="space-y-2 text-sm text-gray-700 dark:text-gray-300">
                <p id="noHistory" class="text-gray-500 text-sm italic dark:text-gray-400">Chưa có lịch sử chuyển đổi nào.</p>
                <!-- History items will be inserted here -->
            </div>
        </div>

        <!-- FOOTER: THÔNG TIN TÁC GIẢ VÀ BÁCH KHOA HÀ NỘI -->
        <div class="app-footer">
            <!-- Thay placeholder bằng logo HUST (Placeholder HUST) -->
            <img src="https://placehold.co/100x100/BC002D/FFFFFF?text=HUST" 
                 onerror="this.style.display='none'" 
                 class="hust-logo" 
                 alt="Logo ĐH Bách Khoa Hà Nội">
            <p class="text-xs font-medium text-gray-600 dark:text-gray-400 transition-colors">Đại học Bách Khoa Hà Nội (HUST)</p>
            <p class="text-xs text-gray-500 dark:text-gray-500 transition-colors">Phát triển bởi 
                <!-- Đã thêm Link Facebook -->
                <a href="https://web.facebook.com/profile.php?id=61576128322437" target="_blank" class="fb-link">
                    <i class="fab fa-facebook-f mr-1"></i>Lợi Lê IT E6
                </a>
            </p>
        </div>
        
    </div>

    <!-- MÃ JAVASCRIPT -->
    <script>
        // Các hàm tiện ích
        const $ = selector => document.querySelector(selector);
        const $$ = selector => document.querySelectorAll(selector);

        // --- CÀI ĐẶT MATRIX BACKGROUND (JAPANESE CODE STYLE) ---
        const canvas = $('#matrix-background');
        const ctx = canvas.getContext('2d');
        let width = window.innerWidth;
        let height = window.innerHeight;
        let columns;
        let drops;
        
        // Ký tự Katakana và Số - Nhật Bản
        const katakana = 'アァカサタナハマヤラワガザダバパイィキシチニヒミリヰギジヂビピウゥクスツヌフムユルグズブプエェケセテネヘメレヱゲゼデベペオォコソトノホモヨロヲゴゾドボポヴッン0123456789';
        const characters = katakana.split('');
        const fontSize = 16;
        let matrixFillStyle = '#00FF41'; // Mặc định xanh neon
        
        function initMatrix() {
            width = window.innerWidth;
            height = window.innerHeight;
            canvas.width = width;
            canvas.height = height;
            
            columns = Math.floor(width / fontSize);
            drops = new Array(columns).fill(1); // Mảng giọt nước
            
            ctx.fillStyle = "#000000";
            ctx.fillRect(0, 0, width, height);
        }
        
        window.addEventListener('resize', initMatrix);
        initMatrix();

        function draw() {
            // Lớp nền mờ
            ctx.fillStyle = 'rgba(0, 0, 0, 0.02)';
            ctx.fillRect(0, 0, width, height);
            
            // Màu chữ code (Thay đổi theo Theme)
            ctx.fillStyle = matrixFillStyle; 
            ctx.font = fontSize + 'px monospace'; // Font monospace cho cảm giác code
            
            for (let i = 0; i < drops.length; i++) {
                const text = characters[Math.floor(Math.random() * characters.length)];
                
                // Vẽ chữ
                ctx.fillText(text, i * fontSize, drops[i] * fontSize);
                
                // Reset giọt nước khi nó chạm đáy hoặc random (tỉ lệ 0.975)
                if (drops[i] * fontSize > height && Math.random() > 0.975) {
                    drops[i] = 0;
                }
                
                drops[i]++;
            }
        }
        
        setInterval(draw, 33); // Tốc độ vẽ

        // --- HÀM CHUYỂN ĐỔI CHÍNH: SỐ -> ROMAJI VÀ ROMAJI -> HIRAGANA ---
        
        const numberMap = {
            1: 'ichi', 2: 'ni', 3: 'san', 4: 'yon', 5: 'go', 6: 'roku', 7: 'nana', 8: 'hachi', 9: 'kyuu', 0: 'zero',
            10: 'juu', 100: 'hyaku', 1000: 'sen', 10000: 'man',
            300: 'sanbyaku', 600: 'roppyaku', 800: 'happyaku',
            3000: 'sanzen', 8000: 'hassen',
        };

        const hiraganaMap = {
            'a': 'あ', 'i': 'い', 'u': 'う', 'e': 'え', 'o': 'お',
            'ka': 'か', 'ki': 'き', 'ku': 'く', 'ke': 'け', 'ko': 'こ',
            'sa': 'さ', 'shi': 'し', 'su': 'す', 'se': 'せ', 'so': 'そ',
            'ta': 'た', 'chi': 'ち', 'tsu': 'つ', 'te': 'て', 'to': 'と',
            'na': 'な', 'ni': 'に', 'nu': 'ぬ', 'ne': 'ね', 'no': 'の',
            'ha': 'は', 'hi': 'ひ', 'fu': 'ふ', 'he': 'へ', 'ho': 'ほ',
            'ma': 'ま', 'mi': 'み', 'mu': 'む', 'me': 'め', 'mo': 'も',
            'ya': 'や', 'yu': 'ゆ', 'yo': 'よ',
            'ra': 'ら', 'ri': 'り', 'ru': 'る', 're': 'れ', 'ro': 'ろ',
            'wa': 'わ', 'wo': 'を', 'n': 'ん',
            'ga': 'が', 'gi': 'ぎ', 'gu': 'ぐ', 'ge': 'げ', 'go': 'ご',
            'za': 'ざ', 'ji': 'じ', 'zu': 'ず', 'ze': 'ぜ', 'zo': 'ぞ',
            'da': 'だ', 'de': 'で', 'do': 'ど',
            'ba': 'ば', 'bi': 'び', 'bu': 'ぶ', 'be': 'べ', 'bo': 'ぼ',
            'pa': 'ぱ', 'pi': 'ぴ', 'pu': 'ぷ', 'pe': 'ぺ', 'po': 'ぽ',
            
            // Âm dài và các âm đặc biệt (Đã được chuyển đổi trong hàm logic)
            'juu': 'じゅう', 'hyaku': 'ひゃく', 'sen': 'せん', 'man': 'まん', 'zero': 'ぜろ',
            
            'ichiman': 'いちまん',
            'sanbyaku': 'さんびゃく', 'roppyaku': 'ろっぴゃく', 'happyaku': 'はっぴゃく',
            'sanzen': 'さんぜん', 'hassen': 'はっせん',
            'ichi': 'いち', 'ni': 'に', 'san': 'さん', 'yon': 'よん', 
            'go': 'ご', 'roku': 'ろく', 'nana': 'なな', 'hachi': 'はち', 'kyuu': 'きゅう',
            'juu': 'じゅう'
        };

        function romajiToHiragana(romaji) {
            // Chuẩn hóa Romaji để xử lý các từ ghép số đặc biệt
            // Tách các từ Romaji số đặc biệt
            for (const key in hiraganaMap) {
                if (key.length > 2) { // Chỉ xử lý các từ dài như juu, hyaku, ichiman, sanbyaku...
                    romaji = romaji.replace(new RegExp(key, 'g'), `__${key}__`);
                }
            }

            // Chia Romaji đã được xử lý thành các phần
            let parts = romaji.split('__').filter(p => p.length > 0);
            let hiragana = '';

            for (let part of parts) {
                if (hiraganaMap[part]) {
                    hiragana += hiraganaMap[part]; // Nếu là từ đặc biệt, sử dụng Hiragana đặc biệt
                } else {
                    // Xử lý các âm tiết còn lại
                    
                    let temp = '';
                    let i = 0;
                    while (i < part.length) {
                        let matched = false;

                        // Ưu tiên khớp 3 ký tự (kyuu, shi, tsu...)
                        if (i + 3 <= part.length && hiraganaMap[part.substring(i, i + 3)]) {
                            temp += hiraganaMap[part.substring(i, i + 3)];
                            i += 3;
                            matched = true;
                        } 
                        // Ưu tiên khớp 2 ký tự (sa, ki, ta...)
                        else if (i + 2 <= part.length && hiraganaMap[part.substring(i, i + 2)]) {
                            temp += hiraganaMap[part.substring(i, i + 2)];
                            i += 2;
                            matched = true;
                        } 
                        // Khớp 1 ký tự (n, a, i, u, e, o)
                        else if (i + 1 <= part.length && hiraganaMap[part.substring(i, i + 1)]) {
                            temp += hiraganaMap[part.substring(i, i + 1)];
                            i += 1;
                            matched = true;
                        }
                        // Xử lý âm 't' nhỏ (âm đôi)
                        else if (part[i] === part[i+1] && i + 1 < part.length && 'ksthnmrygbp'.includes(part[i+1])) {
                             temp += 'っ';
                             i += 1; // Chỉ tiêu thụ 1 ký tự, để ký tự đôi tiếp theo được xử lý bình thường (ví dụ: roppyaku -> ro-p-pyaku)
                             matched = true;
                        }
                         else {
                            // Nếu không khớp, thêm nguyên văn
                            console.warn("Lỗi chuyển đổi Hiragana ở Romaji: " + part.substring(i));
                            temp += part[i]; 
                            i++;
                        }
                    }
                    
                    hiragana += temp;
                }
            }
            
            // Xử lý các trường hợp âm kép đặc biệt trong Hiragana nếu còn sót
            // Ví dụ: ju-u -> jū (giọng dài)
            hiragana = hiragana.replace(/うう/g, 'う');
            hiragana = hiragana.replace(/おお/g, 'おう');
            
            return hiragana;
        }


        function convertToRomaji(num) {
            if (num < 0 || num > 9999999) return "Số phải nằm trong khoảng 0 đến 9,999,999.";
            if (num === 0) return numberMap[0];

            let romaji = '';
            let tempNum = num;

            // Xử lý Hàng triệu (Man)
            if (tempNum >= 10000) {
                const manPart = Math.floor(tempNum / 10000);
                tempNum %= 10000;
                
                if (manPart > 1) {
                    romaji += convertLessThan10000(manPart) + 'man';
                } else if (manPart === 1) {
                    romaji += 'ichiman'; // 10,000 thường là ichiman
                }
            }

            // Xử lý Hàng ngàn, Trăm, Chục, Đơn vị (Dưới 10000)
            if (tempNum > 0) {
                romaji += convertLessThan10000(tempNum);
            }

            // Loại bỏ trường hợp chuỗi rỗng
            return romaji.trim() || convertLessThan10000(num);
        }

        function convertLessThan10000(n) {
            let s = '';
            let num = n;

            // Xử lý Hàng ngàn (Sen)
            if (num >= 1000) {
                const sen = Math.floor(num / 1000);
                num %= 1000;
                
                if (sen === 3) s += 'sanzen'; 
                else if (sen === 8) s += 'hassen';
                else if (sen === 1) s += 'sen';
                else s += numberMap[sen] + 'sen';
            }

            // Xử lý Hàng trăm (Hyaku)
            if (num >= 100) {
                const hyaku = Math.floor(num / 100);
                num %= 100;
                
                if (hyaku === 1) s += 'hyaku';
                else if (hyaku === 3) s += 'sanbyaku';
                else if (hyaku === 6) s += 'roppyaku';
                else if (hyaku === 8) s += 'happyaku';
                else s += numberMap[hyaku] + 'hyaku';
            }

            // Xử lý Hàng chục (Juu)
            if (num >= 10) {
                const juu = Math.floor(num / 10);
                num %= 10;
                s += (juu === 1 ? 'juu' : numberMap[juu] + 'juu');
            }

            // Xử lý Đơn vị
            if (num > 0) {
                s += numberMap[num];
            }
            return s;
        }

        // --- LOGIC GIAO DIỆN VÀ SỰ KIỆN ---

        const inputNumber = $('#inputNumber');
        const convertButton = $('#convertButton');
        const resultBox = $('#resultBox');
        const romajiOutput = $('#romajiOutput');
        const hiraganaOutput = $('#hiraganaOutput');
        const speakerButton = $('#speakerButton');
        const copyRomajiButton = $('#copyRomajiButton');
        const copyHiraganaButton = $('#copyHiraganaButton');
        const errorMessage = $('#errorMessage');
        const errorText = $('#errorText');
        const autoSpeakCheckbox = $('#autoSpeakCheckbox');
        const historyList = $('#historyList');
        const noHistory = $('#noHistory');
        const clearButton = $('#clearButton');
        const refreshButton = $('#refreshButton');
        const themeToggle = $('#themeToggle');
        const themeIcon = $('#themeIcon');
        const themeText = $('#themeText');

        let conversionHistory = []; // Mảng lưu lịch sử

        // Speech Synthesis API
        let voices = [];
        const voiceSelect = $('#voiceSelect');
        const rateRange = $('#rateRange');
        const pitchRange = $('#pitchRange');
        const rateValue = $('#rateValue');
        const pitchValue = $('#pitchValue');
        
        function populateVoiceList() {
            voices = speechSynthesis.getVoices();
            voiceSelect.innerHTML = '';
            
            // LỌC: CHỈ GIỮ LẠI CÁC GIỌNG TIẾNG NHẬT (ja-JP)
            const jaVoices = voices.filter(voice => voice.lang.startsWith('ja'));
            
            if (jaVoices.length === 0) {
                const fallbackOption = document.createElement('option');
                fallbackOption.textContent = 'Giọng đọc mặc định (Không phải tiếng Nhật)';
                fallbackOption.value = 'default_fallback';
                voiceSelect.appendChild(fallbackOption);
                
                errorText.textContent = "Cảnh báo: Trình duyệt của bạn không tìm thấy giọng đọc tiếng Nhật (ja-JP). Âm thanh có thể bị phát âm sai.";
                errorMessage.classList.remove('hidden');
            } else {
                jaVoices.forEach((voice, index) => {
                    const option = document.createElement('option');
                    option.textContent = `${voice.name} (${voice.lang})`;
                    option.value = voice.name;
                    if (voice.default) { // Ưu tiên giọng mặc định nếu có
                         option.selected = true;
                    }
                    voiceSelect.appendChild(option);
                });
                errorMessage.classList.add('hidden');
                
                if (voiceCheckInterval) {
                    clearInterval(voiceCheckInterval);
                }
            }
        }
        
        let voiceCheckInterval = null; 
        function startVoiceCheck() {
             populateVoiceList();
             if (voices.length === 0) {
                 voiceCheckInterval = setInterval(populateVoiceList, 200);
             }
        }
        
        if (speechSynthesis.onvoiceschanged !== undefined) {
            speechSynthesis.onvoiceschanged = populateVoiceList;
        }
        window.onload = startVoiceCheck;

        // Cập nhật giá trị Rate/Pitch
        rateRange.addEventListener('input', () => rateValue.textContent = rateRange.value);
        pitchRange.addEventListener('input', () => pitchValue.textContent = pitchRange.value);

        // --- XỬ LÝ LỊCH SỬ ---
        function saveToHistory(number, romaji, hiragana) {
            const newItem = { number, romaji, hiragana, time: new Date().toLocaleTimeString() };
            // Thêm vào đầu mảng
            conversionHistory.unshift(newItem);
            // Giới hạn 5 mục
            if (conversionHistory.length > 5) {
                conversionHistory.pop();
            }
            renderHistory();
        }

        function renderHistory() {
            historyList.innerHTML = '';
            if (conversionHistory.length === 0) {
                noHistory.classList.remove('hidden');
                return;
            }

            noHistory.classList.add('hidden');
            
            conversionHistory.forEach(item => {
                const div = document.createElement('div');
                div.className = 'history-item flex justify-between items-center text-xs';
                div.setAttribute('data-number', item.number);
                div.innerHTML = `
                    <div>
                        <span class="font-bold text-base text-red-700 dark:text-red-400 mr-2">${item.number}</span>
                        <span class="font-mono">${item.romaji}</span> 
                        <span class="text-gray-500 text-sm"> / ${item.hiragana}</span>
                    </div>
                    <span class="text-gray-400 italic">${item.time}</span>
                `;
                
                div.addEventListener('click', () => {
                    inputNumber.value = item.number;
                    convertAndDisplay(item.number);
                });
                historyList.appendChild(div);
            });
        }

        // --- HÀM XỬ LÝ CHUYỂN ĐỔI VÀ HIỂN THỊ CHÍNH ---
        function convertAndDisplay(num) {
            const romaji = convertToRomaji(num);

            // Ẩn kết quả cũ trước khi chạy animation
            resultBox.style.opacity = '0'; 
            resultBox.style.transform = 'scale(0.95) translateY(10px)';
            resultBox.classList.remove('glowing');

            if (romaji.startsWith("Số phải nằm")) {
                errorText.textContent = romaji;
                errorMessage.classList.remove('hidden');
                resultBox.classList.add('hidden');
            } else {
                const hiragana = romajiToHiragana(romaji);

                // Cập nhật DOM
                romajiOutput.textContent = romaji;
                hiraganaOutput.textContent = hiragana;
                
                errorMessage.classList.add('hidden');
                resultBox.classList.remove('hidden');

                // Hiệu ứng hiện kết quả mượt (animation)
                setTimeout(() => {
                    resultBox.style.opacity = '1';
                    resultBox.style.transform = 'scale(1) translateY(0)';
                    resultBox.classList.add('glowing'); // Thêm hiệu ứng glowing
                }, 100); 

                // Tự động đọc (Tính năng 1)
                if (autoSpeakCheckbox.checked) {
                    // Phát âm Hiragana để giọng đọc tự nhiên nhất
                    speakText(hiragana);
                }

                // Lưu lịch sử
                saveToHistory(num, romaji, hiragana);
            }
        }


        // --- EVENT LISTENERS ---
        convertButton.addEventListener('click', () => {
            const numStr = inputNumber.value.trim();
            const num = parseInt(numStr);
            
            if (numStr === "" || isNaN(num)) {
                 errorText.textContent = "Lỗi: Vui lòng nhập một số hợp lệ.";
                 errorMessage.classList.remove('hidden');
                 resultBox.classList.add('hidden');
                 return;
            }
            
            convertAndDisplay(num);
        });

        // HÀM XỬ LÝ PHÁT ÂM (Tối ưu cho iOS)
        function speakText(text) {
            if (!text) return;
            
            if (speechSynthesis.speaking) {
                speechSynthesis.cancel();
            }

            const utterance = new SpeechSynthesisUtterance(text);
            const currentVoices = speechSynthesis.getVoices();
            const selectedVoiceName = voiceSelect.value;
            const selectedVoice = currentVoices.find(voice => voice.name === selectedVoiceName);
            
            if (selectedVoice && selectedVoiceName !== 'default_fallback') {
                utterance.voice = selectedVoice;
            }

            utterance.lang = 'ja-JP';
            utterance.rate = parseFloat(rateRange.value);
            utterance.pitch = parseFloat(pitchRange.value);
            
            utterance.onerror = (event) => {
                console.error("Speech Synthesis Error:", event);
            };

            speechSynthesis.speak(utterance);
        }

        speakerButton.addEventListener('click', () => {
            const textToSpeak = hiraganaOutput.textContent || romajiOutput.textContent; 
            speakText(textToSpeak);
        });

        function copyToClipboard(text, buttonElement) {
            if (text) {
                const el = document.createElement('textarea');
                el.value = text;
                document.body.appendChild(el);
                el.select();
                document.execCommand('copy');
                document.body.removeChild(el);

                const originalText = buttonElement.innerHTML;
                buttonElement.innerHTML = '<i class="fas fa-check mr-1"></i> Xong!';
                buttonElement.style.backgroundColor = '#10B981'; 
                buttonElement.style.color = 'white';
                
                setTimeout(() => {
                    buttonElement.innerHTML = originalText;
                    buttonElement.style.backgroundColor = '';
                    buttonElement.style.color = '';
                }, 1500);
            }
        }

        copyRomajiButton.addEventListener('click', () => {
            copyToClipboard(romajiOutput.textContent, copyRomajiButton);
        });

        copyHiraganaButton.addEventListener('click', () => {
            copyToClipboard(hiraganaOutput.textContent, copyHiraganaButton);
        });

        // Xử lý sự kiện Enter
        inputNumber.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                convertButton.click();
            }
        });
        
        // --- TÍNH NĂNG 2: NÚT XÓA NHANH VÀ LÀM MỚI ---
        clearButton.addEventListener('click', () => {
            inputNumber.value = '';
            resultBox.classList.add('hidden');
            errorMessage.classList.add('hidden');
            resultBox.classList.remove('glowing');
            speechSynthesis.cancel(); // Dừng đọc nếu đang đọc
        });

        refreshButton.addEventListener('click', () => {
            window.location.reload();
        });

        // --- TÍNH NĂNG 6: DARK MODE TOGGLE ---
        function toggleTheme() {
            const isDark = document.body.classList.toggle('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');

            if (isDark) {
                themeIcon.className = 'fas fa-sun';
                themeText.textContent = 'Chủ đề Sáng';
                matrixFillStyle = '#FFD700';
            } else {
                themeIcon.className = 'fas fa-moon';
                themeText.textContent = 'Chủ đề Tối';
                matrixFillStyle = '#00FF41';
            }
        }

        themeToggle.addEventListener('click', toggleTheme);

        // Áp dụng theme đã lưu khi tải trang
        function applyInitialTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            if (savedTheme === 'dark') {
                document.body.classList.add('dark');
                themeIcon.className = 'fas fa-sun';
                themeText.textContent = 'Chủ đề Sáng';
                matrixFillStyle = '#FFD700';
            } else {
                document.body.classList.remove('dark');
                themeIcon.className = 'fas fa-moon';
                themeText.textContent = 'Chủ đề Tối';
                matrixFillStyle = '#00FF41';
            }
        }

        applyInitialTheme();
        
        // Khởi tạo lịch sử sau khi DOM đã sẵn sàng
        renderHistory();

    </script>
</body>
</html>

